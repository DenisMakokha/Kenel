name: Deploy on Push

on:
  push:
    branches: ["main", "staging"]

env:
  NODE_VERSION: "20"

jobs:
  # Detect what changed and which environment
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      is_production: ${{ github.ref == 'refs/heads/main' }}
      is_staging: ${{ github.ref == 'refs/heads/staging' }}
      environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'
      - name: Log environment
        run: |
          echo "üéØ Deploying to: ${{ github.ref == 'refs/heads/main' && 'PRODUCTION' || 'STAGING' }}"
          echo "Branch: ${{ github.ref_name }}"

  # Run migrations if backend changed (PRODUCTION ONLY)
  migrate:
    needs: changes
    if: needs.changes.outputs.backend == 'true' && needs.changes.outputs.is_production == 'true'
    runs-on: ubuntu-latest
    environment: SSH_HOST
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Pull code and run migrations
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'ENDSSH'
            set -e
            cd ${{ secrets.API_DIR }}
            
            echo "üì• Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            
            cd backend
            
            echo ""
            echo "üìã Checking migration status..."
            ./node_modules/.bin/prisma migrate status || true
            
            echo ""
            echo "üì¶ Installing dependencies..."
            npm install --omit=dev
            
            echo ""
            echo "üóÑÔ∏è Generating Prisma client..."
            ./node_modules/.bin/prisma generate
            
            echo ""
            echo "üîÑ Running database migrations (only pending)..."
            ./node_modules/.bin/prisma migrate deploy || {
              echo "‚ö†Ô∏è Migration deploy failed, checking if baselining needed..."
              
              # If P3005 error (non-baselined), mark existing as applied
              for migration in $(ls -1 prisma/migrations/ | grep -E '^[0-9]+' | sort); do
                echo "  Marking $migration as applied..."
                ./node_modules/.bin/prisma migrate resolve --applied "$migration" 2>/dev/null || true
              done
              
              echo "üîÑ Retrying migration deploy..."
              ./node_modules/.bin/prisma migrate deploy
            }
            
            echo ""
            echo "‚úÖ Migrations complete!"
          ENDSSH

  # Deploy backend (PRODUCTION ONLY - staging shares the same API)
  deploy-backend:
    needs: [changes, migrate]
    if: always() && needs.changes.outputs.backend == 'true' && needs.changes.outputs.is_production == 'true' && (needs.migrate.result == 'success' || needs.migrate.result == 'skipped')
    runs-on: ubuntu-latest
    environment: SSH_HOST
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Build and restart backend
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'ENDSSH'
            set -e
            cd ${{ secrets.API_DIR }}/backend
            
            echo "üî® Building application..."
            npm run build
            
            echo ""
            echo "üöÄ Restarting PM2 process..."
            pm2 restart kenels-api || pm2 start dist/main.js --name kenels-api
            pm2 save
            
            echo ""
            echo "üè• Health check..."
            sleep 3
            curl -sf http://localhost:3000/api/health > /dev/null && echo "‚úÖ API is healthy!" || echo "‚ö†Ô∏è Health check pending..."
            
            echo ""
            echo "‚úÖ Backend deployment complete!"
          ENDSSH

  # Deploy frontend (staging ‚Üí test.kenels.app, production ‚Üí kenels.app)
  deploy-frontend:
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    environment: SSH_HOST
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        working-directory: frontend
        run: pnpm install

      - name: Build application
        working-directory: frontend
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: pnpm run build

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Determine deployment target
        id: target
        run: |
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "app_dir=${{ secrets.APP_DIR }}" >> $GITHUB_OUTPUT
            echo "env_name=PRODUCTION (kenels.app)" >> $GITHUB_OUTPUT
          else
            echo "app_dir=${{ secrets.STAGING_APP_DIR }}" >> $GITHUB_OUTPUT
            echo "env_name=STAGING (test.kenels.app)" >> $GITHUB_OUTPUT
          fi

      - name: Deploy frontend to server
        run: |
          echo "üéØ Deploying to: ${{ steps.target.outputs.env_name }}"
          
          # Create a tarball for atomic upload
          echo "üì¶ Creating deployment package..."
          cd frontend/dist
          tar -czf ../../frontend-build.tar.gz .
          cd ../..
          
          # Upload tarball
          echo "üì§ Uploading build package..."
          scp frontend-build.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/frontend-build.tar.gz
          
          # Atomic deployment on server
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << ENDSSH
            set -e
            
            APP_DIR="${{ steps.target.outputs.app_dir }}"
            TEMP_DIR="\${APP_DIR}_new"
            BACKUP_DIR="\${APP_DIR}_backup"
            
            echo "üìÇ Deploying to: \$APP_DIR"
            echo "üìÇ Preparing deployment directories..."
            rm -rf "\$TEMP_DIR" "\$BACKUP_DIR"
            mkdir -p "\$TEMP_DIR"
            
            echo "üì¶ Extracting new build..."
            tar -xzf /tmp/frontend-build.tar.gz -C "\$TEMP_DIR"
            rm /tmp/frontend-build.tar.gz
            
            echo "üîÑ Performing atomic swap..."
            # Backup current (if exists)
            if [ -d "\$APP_DIR" ] && [ "\$(ls -A \$APP_DIR 2>/dev/null)" ]; then
              mv "\$APP_DIR" "\$BACKUP_DIR"
            fi
            
            # Swap in new version
            mv "\$TEMP_DIR" "\$APP_DIR"
            
            echo "üîê Setting permissions..."
            chmod -R 755 "\$APP_DIR"
            
            # Cleanup backup on success
            rm -rf "\$BACKUP_DIR"
            
            echo ""
            echo "‚úÖ Frontend deployment to ${{ steps.target.outputs.env_name }} complete!"
          ENDSSH

  # Summary
  summary:
    needs: [changes, migrate, deploy-backend, deploy-frontend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "=========================================="
          echo "üìä Deployment Summary"
          echo "=========================================="
          echo ""
          echo "Backend changes detected: ${{ needs.changes.outputs.backend }}"
          echo "Frontend changes detected: ${{ needs.changes.outputs.frontend }}"
          echo ""
          echo "Migration result: ${{ needs.migrate.result }}"
          echo "Backend deploy result: ${{ needs.deploy-backend.result }}"
          echo "Frontend deploy result: ${{ needs.deploy-frontend.result }}"
          echo ""
          
          if [[ "${{ needs.migrate.result }}" == "failure" ]] || \
             [[ "${{ needs.deploy-backend.result }}" == "failure" ]] || \
             [[ "${{ needs.deploy-frontend.result }}" == "failure" ]]; then
            echo "‚ùå Some deployments failed!"
            exit 1
          else
            echo "‚úÖ All deployments successful!"
          fi
